<?php
/**
 * @file
 * Message notify module.
 */

/**
 * Add defaults values to the notifier plugins.
 *
 * - 'description': The description of the plugin.
 * - 'options': Array with the following keys:
 *   - 'save on fail': Save the message is delivery failed. Defaults to
 *     TRUE.
 *   - 'save on success': Save the message is delivery successded. Defaults to
 *     TRUE.
 *   - 'language override': Override user's language, and use the
 *     Message's language. Defaults to FALSE.
 *   - 'rendered fields': Array keyed with the view mode(s), and the text
 *     field(s) to save the rendered output.
 *     The rendered field is used when it is needed to save the message
 *     exactly as it was sent (for example for message logs), as it might
 *     change and show differently when viewed later - as a result of on
 *     the fly token replacement, or even editing the message type.
 */
function message_notify_plugin_process(&$plugin, $info) {
  $plugin += array(
    'description' => '',
    'options' => array(),
  );
  $plugin['options'] += array(
    'save on fail' => TRUE,
    'save on success' => TRUE,
    'language override' => FALSE,
    'rendered fields' => array(),
  );
}

/**
 * Implements hook_entity_info_alter().
 *
 * Add a the notifiers view modes.
 */
function message_notify_entity_info_alter(&$entity_info) {
  foreach (message_notify_get_notifiers() as $plugin) {
    $view_modes = $plugin['view_modes'];
    // Set default values.
    foreach ($view_modes as &$view_mode) {
      $view_mode += array('custom settings' => TRUE);
    }
    $entity_info['message']['view modes'] += $view_modes;
  }
}

/**
 * Implements hook_mail().
 *
 * Set's the message subject and body as configured.
 */
function message_notify_mail($key, &$message, $params) {
  $message['subject'] = $params['mail_title'];
  $message['body'][] = $params['mail_body'];
}

/**
 * Implements hook_entity_bundle_create().
 *
 * We cannot easily set the the visibilty of extra fields, so we set the
 * bundle settings upon creation of new message bundle.
 */
function message_notify_entity_bundle_create($entity_type_id, $bundle) {
  if ($entity_type_id != 'message') {
    return;
  }

  // Setup the subject and body display modes.
  // @todo
}

/**
 * Implements hook_ctools_plugin_api().
 */
function message_notify_ctools_plugin_api($module, $api) {
  if ($module == 'message_notify' && $api == 'notifier') {
    return array('version' => 1);
  }
}

/**
 * Implements hook_ctools_plugin_type().
 */
function message_notify_ctools_plugin_type() {
  $plugins['notifier'] = array(
    'classes' => array('class'),
    'process' => 'message_notify_plugin_process',
  );
  return $plugins;
}

/**
 * Implements hook_ctools_plugin_directory().
 */
function message_notify_ctools_plugin_directory($module, $plugin) {
  if ($module == 'message_notify') {
    return 'plugins/' . $plugin;
  }
}

/**
 * Helper function to include CTools plugins and get all notifier plugins.
 */
function message_notify_get_notifiers() {
  // @FIXME
// Most CTools APIs have been moved into core.
// 
// @see https://www.drupal.org/node/2164623
// ctools_include('plugins');

  return \Drupal::service('plugin.manager.message_notify.notifier')->getDefinitions();
}

/**
 * Helper function to return all notifiers as options for a select list.
 */
function message_notify_get_notifiers_as_options() {
  $notifiers = message_notify_get_notifiers();
  $options = array();
  foreach ($notifiers as $notifier_name => $notifier) {
    $options[$notifier_name] = \Drupal\Component\Utility\Html::escape($notifier['title']);
  }

  return $options;
}

/**
 * Deprectaed: Send email.
 *
 * Wrapper function for message_notify_send_message(), using the "email"
 * notifier.
 *
 * @deprecated
 */
function message_notify_send_mail(Message $message, array $options = array()) {
  message_notify_send_message($message, $options, 'email');
}
